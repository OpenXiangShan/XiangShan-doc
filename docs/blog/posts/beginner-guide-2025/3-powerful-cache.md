---
slug: "memory-access-827-3-powerful-cache"
date: 2025-11-02
categories:
  - "2025 香山入门指南"
links:
  - blog/posts/beginner-guide-2025/0-before-start.md
  - blog/posts/beginner-guide-2025/1-ooo-memory-access.md
  - blog/posts/beginner-guide-2025/2-memory-access-pipeline.md
  - blog/posts/beginner-guide-2025/3-powerful-cache.md
  - blog/posts/beginner-guide-2025/4-virtual-memory.md
  - blog/posts/beginner-guide-2025/5-atomic-operation.md
---

# 【2025 香山入门指南 · 我在 827 做访存】（三）更大更快更强的缓存

编者相信，对大部分读到本文的读者来说，起码是了解处理器中 Cache 的基本概念的。因此笔者不再会特别赘述 Cache 的基础概念。

<!-- more -->

---

!!! note "经典体系结构的优化方式"
    一般来说，我们认为经典体系结构有着 4 种基本的优化方法：利用局部性、提高并行度、预测、采用特定领域的加速结构设计。

    我强烈建议没有做过一生一芯或者一生一芯没有看过这个文档的同学先去看一下下面的一生一芯文档“性能优化和建议缓存”，相信读者一定可以在濠神的文章中收获到一些知识。上面提到的经典体系结构的优化方式也是编者在这篇一生一芯的文档中学习到的，这篇文档还介绍了有关 Cache 的概念，如果你不了解 Cache 的话也建议你读一下。


---

**<font style="color:#DF2A3F;">请阅读下面的一生一芯文档：</font>**

**如果你了解 Cache 的基础概念，那这****<font style="color:#74B602;">不是必做题</font>****，**

**但如果你还不是很了解 Cache 的基础概念，那这****<font style="color:#DF2A3F;">就是一道必做题</font>****。**

[B3 性能优化和简易缓存 | 官方文档](https://ysyx.oscc.cc/docs/2306/basic/1.9.html#%E7%BB%8F%E5%85%B8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%9A%844%E7%B1%BB%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95)

---

简单来说，Cache 就是一大块给定输入的地址，输出出地址对应的数据的一块硬件上的存储结构。现代处理器一般采用多级分离的 Cache 层次结构，香山也不例外。

香山一共具有 L1、L2、L3 三级 Cache，而 L1 Cache 又分为独立的 DCache 与 ICache。

目前，L1 与 L2 Cache 为香山团队设计的，这其中，L2 Cache 需要承接上下级存储结构，由负责缓存的的师兄们单独设计，我们也有专门的缓存相关的新手村入门文档：  
占位符

同时，由于 L1 ICache 不属于缓存一致性节点，也与 L1 DCache 相互独立，在访存侧不会涉及 L1 ICache 的相关逻辑，因此，L1 ICache 的相关内容由前端的同学负责开发维护，相关的新手村入门文档在这：  
占位符

因此，本文只会涉及到 L1 DCache 的相关内容，有关缓存一致性也只会有关缓存一致性的相关问题也只会简单提及，具体的缓存一致性问题由于与总线和缓存一致性协议密切相关，如果感兴趣请到上面提到的缓存相关的新手村入门文档中学习。

对于 L1 DCache，下面统一称为 DCache，其主要存储模块构成就是：

+ **bankedDataArray**
+ **metaArray**
+ **tagArray**

这些模块保证了 DCache 正常工作所需的权限、地址和数据。

**DCache 采用 4Way 组相连，每组分为了 8 个 Bank，同时采用了 VIPT 的查询方式。**

---

!!! danger
    如果你不清楚上面这句话在说什么，请检索互联网并重新学习 Cache 的相关知识。



## 由缓存一致性说起
正如我刚才提到的，缓存一致性并不是这篇新手村的重点，但为了让整篇文章的逻辑更加完整，编者还是在这里简单的介绍一下缓存一致性。

有一个不错的比喻可以和大家分享：

---

!!! warning "某位前一生一芯助教的读书笔记："
    我们来看一个直观的例子。一个学生检查了在线课程表，发现计算机结构课程在152教室（读取数据），并将此信息复制到手机中（缓存数据）。随后，教务处决定将课程移到252室，更新了在线课程表（写入数据），并通过短信通知学生。注意此时学生手机里的信息现在已经过时了，发生了缓存不一致的情况。如果这时学生按照手机里的信息前往152教室，就会发现走错教室了。

    对过时数据的访问是通过缓存一致性协议来避免的，缓存一致性协议在同步发生的时间和方式上存在差异，有两类主要的一致性协议。第一类方法中，一致性协议确保写入的内容同步传播到各个缓存中；第二类方法中，一致性协议将写入的内容异步传播到缓存中，且仍然保证一致性。



    _这是一位前一生一芯助教的读书笔记中对于缓存一致性的一段比较有意思描述，编者感觉还是比较贴切的，故而分享给大家。—— shili _[_https://shili2017.github.io/posts/MCCC1/_](https://shili2017.github.io/posts/MCCC1/)


缓存一致性协议正是想尝试解决类似上面比喻中提到的问题的。

简单来说，我们期望通过缓存一致性协议来解决类似如下的问题：**保证多核心间需要共享的数据是一致的。当然，我们还想尽可能的提高多核核间共享数据的性能。**

---

!!! note "不需要共享的自然不需要保证"
    如上所言，尽管编者对缓存的造诣并不深刻，但是编者感觉自己的简单总结还是比较合适的。🫡

    所谓需要共享的数据需要一致，指的是这个数据需要位于一致性节点中。

    例如，在 RISC-V 中，允许 Store Buffer 的存在脱离内存一致性，也就是说，如果其中一个核将数据写入了 Store Buffer，那么另一个核读不到这个新的写入的数据也无所谓的，缓存一致性不需要保证这种情况。

    而如果一个核心已经先将数据写入了自己的 DCache 中，那么在一般情况下，另一个核在之后读取这个数据的时候自然要读到这个核心新写入自己的 DCache 中的数据。

    而这个先后顺序自然也是缓存一致性需要来保证的。


一般而言，缓存一致性协议包括 MESI、MOESI 等，目前昆明湖 V2 实现了 MESI 的缓存一致性协议。

---

**<font style="color:#DF2A3F;">请阅读检索相关资料：</font>**

**MESI 缓存一致性协议是指什么？  
****是如何工作来保证缓存一致性的？**

---

同样的，缓存一致性协议只是一种协议，并不涉及到具体的微架构实现，而且一般情况下，由于现代处理器多级 Cache 的特性，我们需要 Cache 间与片上的总线协议支持对应的缓存一致性协议。

常见的可以支持缓存一致性协议的总线协议有 TileLink、ACE、CHI 总线等等等，每一个总线协议往往都伴随着自身的一致性模型，而这些总线的一致性模型往往可以对应到支持的缓存一致性协议上。

对于目前的昆明湖 V2 而言，我们在 DCache 与 L2 Cache 之间使用了 TileLink 作为总线协议，并将 TileLink 中规定的一致性树对应到了 MESI 协议上。

---

!!! note "不再适合香山的 TileLink？"
    TileLink 是由 SiFive 推出的芯片间总线互连协议，分为三种不同级别的协议标准：TL-UL、TL-UH、TL-C。其中，TL-C 支持兼容支持 MOESI 的缓存一致性协议。

    SiFive 自然不用多说，是 RISC-V 业内著名的芯片设计公司，并且主导推动了许多 RISC-V 有关的协议草案、配套设施等。而 TileLink 更是 SiFive 推出年轻的总线互联协议。

    在香山设计之初，由于 TileLink 与 RISC-V 的千丝万缕的联系以及其他种种原因，我们选择了 TileLink 作为支持实现缓存一致性协议的总线协议，并一直沿用至今。但随着香山的不断演进与越来越复杂多变的使用场景，我们发现 TileLink 不再适合作为香山的总线协议。

    我们在 2024 年进行了 L2 - L3 Cache 间的总线替换工作，我们实现了一个新的支持 CHI 协议的 L2 Cache 来替换之前的使用 TileLink 版本的 L2 Cache。而随着我们对 CHI 协议的研究越来越深入，我们发现，在 L1 使用 TileLink 总线而L2 使用 CHI 总线的情况下，为了支持特殊的新需求与更好的适配 CHI 总线，我们不得不引入很多额外的自定义位。并且由于 TileLink 与 CHI 设计理念的不同，在使用上确实存在一些不协调的问题。

    因此，我们正在计划设计新的 L1 - L2 Cache 的由香山团队自定义的互联总线，以更好的适配香山的演进。


对于 MESI 这些状态位的实现，我们在 DCache 的 metaArray 利用 TileLink 的一致性树来进行了实现，并通过这些状态位与其他的元数据信息一起判断对于 L1 DCache 的访问是否命中。

---

**<font style="color:#DF2A3F;">请阅读检索相关资料：</font>**

**TileLink 协议是如何保证缓存一致性的？**

**TileLink 协议的各个通道的作用是什么？**

**在香山的实现中，是如何将 TileLink 的一致性树与 MESI 状态对应的？**

---

---

**<font style="color:#74B602;">请带着问题阅读代码与文档：</font>**

**DCache 的缓存块的一致性状态是如何转换的？**

**（这是一个比较难且综合的问题，如果你觉得困难，可以先往后看，但是这道题是必答题）**

---

---

**<font style="color:#ECAA04;">请检索阅读相关资料：</font>**

**业界常用的支持缓存一致性的总线协议都有什么？  
****这些协议大致都是怎么样的设计思路？**

---

## 总览
DCache 整体上是由 MainPipe、LoadPipe、Array 以及其他的与总线直接交互的各个 Queue。

![DCache 示意图](images/DCache_示意图_93cd04f4.jpeg)

这里不会将所有的子模块展开介绍，但读者需要自己去了解各个模块的功能。

---

**<font style="color:#DF2A3F;">请带着问题阅读代码与文档：</font>**

**DCache 的各个模块功能是什么？**

[数据高速缓存 DCache - 香山开源处理器设计文档](https://docs.xiangshan.cc/projects/design/zh-cn/latest/memblock/DCache/)

---

## LoadPipe
DCache 最主要的功能是为 LoadUnit 高效的提供对于数据的读取。为此，我们至少需要提供与 LoadUnit 对应的 DCache 中的处理模块，在昆明湖 V2 这个模块叫 —— LoadPipe。

LoadPipe 被例化在 DCache 中，一共有三个 LoadPipe，与 LoadUnit 一一对应，可以并行处理没有冲突的 Load 请求。

LoadPipe 与 LoadUnit 高度相关，如果可以的话，这两者在某种程度是一体两面的。当我们在说：LoadUnit 访问 DCache 的时候，实际上就是在说 LoadUnit 访问 LoadPipe，LoadPipe 访问 Meta/Data Array。

当 LoadUnit 正在请求进行地址翻译、权限检查等等的同时，LoadPipe 也在请求进行缓存查询、权限检查等等。

LoadPipe 高效的处理 LoadUnit 对于 DCache 的访问，并根据 DCache 的权限查询结果进行向下级 Cache 取值、将数据反馈 LoadUnit 等等。

## MainPipe
MainPipe 主要负责处理与向下级 Cache 写相关的操作，包括 Store、Probe、Refill 等等。事实上，我们可以理解为这是一个 StorePipe，MainPipe 主要的功能就是负责将数据向下级 Cache 写。当然，向下级 Cache 写数据也会区分为多种不同的情况，这些情况的条件与一致性要求不同。

---

**<font style="color:#DF2A3F;">请带着问题阅读代码与文档：</font>**

**MainPipe 要处理的写操作都有什么不同？**

[主流水线 MainPipe - 香山开源处理器设计文档](https://docs.xiangshan.cc/projects/design/zh-cn/latest/memblock/DCache/MainPipe/)

---

## 自由探索
DCache 这里主要就为大家简单介绍这些模块。其实编者本人对 DCache 的了解并不深，因此这一大章的目的其实是为大家引入**缓存一致性**这个话题。所以编者就不做力不能支的事情为大家继续介绍 DCache 了，其他的模块就留给大家自己探索了。

---

**<font style="color:#74B602;">请带着问题阅读代码与文档：</font>**

**自由探索这里没有提到的有关 DCache 的细节**

**（这是一个比较难且综合的问题，如果你觉得困难，可以先往后看，但是你就算这个时候逃避了这个问题，你以后的工作也会让你重新回来的。）**

---
